<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ALPACEL | Agenda Sanitaria (Anomal√≠as & Seguimiento)</title>
  <meta name="description" content="Agenda sanitaria ALPACEL: registro de anomal√≠as, seguimiento, sem√°foro por farmacia, checklist sanitario y acta imprimible."/>
  <style>
    :root{
      --bg:#0b1220;
      --card:#121b2f;
      --card2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.08);
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#60a5fa;
      --chip:#1f2a44;
      --shadow: 0 14px 35px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 10% 10%, rgba(96,165,250,.22), transparent 60%),
                 radial-gradient(900px 600px at 90% 20%, rgba(245,158,11,.18), transparent 55%),
                 linear-gradient(180deg, #071022, #050816 55%, #040612);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(5,8,22,.6);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1280px; margin:0 auto; padding:18px 16px;}
    .title{display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,1), rgba(34,197,94,.9));
      box-shadow: var(--shadow);
      display:grid; place-items:center; font-weight:900; color:#061127;
      user-select:none;
    }
    h1{margin:0; font-size:18px; letter-spacing:.2px;}
    .sub{margin-top:2px; color:var(--muted); font-size:13px;}
    .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: .2s ease;
      display:inline-flex; align-items:center; gap:8px;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
    .btn.primary{border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.12)}
    .btn.danger{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10)}
    .btn.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10)}
    .btn.ghost{background: transparent}
    .grid{
      display:grid;
      grid-template-columns: 430px 1fr;
      gap:16px;
      margin-top:16px;
    }
    @media (max-width: 1020px){
      .grid{grid-template-columns: 1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(18,27,47,.92), rgba(15,23,42,.92));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .card .hd h2{margin:0; font-size:15px}
    .card .bd{padding:14px}
    .muted{color:var(--muted)}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    .row4{display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;}
    @media (max-width: 680px){
      .row,.row3,.row4{grid-template-columns: 1fr}
    }
    label{display:block; font-size:12px; color:var(--muted); margin:6px 0 6px}
    input, select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical;}
    input::placeholder, textarea::placeholder{color:rgba(229,231,235,.45)}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      background: rgba(31,42,68,.9);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--text);
      display:inline-flex; gap:8px; align-items:center;
    }
    .dot{width:8px; height:8px; border-radius:99px; display:inline-block}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .dot.info{background:var(--info)}
    .kpis{
      display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;
    }
    @media (max-width: 980px){
      .kpis{grid-template-columns: repeat(2, 1fr)}
    }
    .kpi{
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .kpi .n{font-size:20px; font-weight:800; margin-top:4px}
    .kpi .t{font-size:12px; color:var(--muted)}
    .hr{height:1px; background: var(--line); margin:12px 0}
    .list{display:flex; flex-direction:column; gap:10px; padding:12px;}
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      transition:.2s ease;
    }
    .item:hover{transform: translateY(-1px); background: rgba(255,255,255,.05)}
    .item h3{margin:0; font-size:14px}
    .meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .badge{
      font-size:11px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      white-space:nowrap;
    }
    .badge.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .badge.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12)}
    .badge.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12)}
    .badge.info{border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.12)}
    .actions{display:flex; flex-direction:column; gap:8px; align-items:flex-end;}
    .small{font-size:12px}
    .hint{font-size:12px; color:var(--muted); line-height:1.45}
    .footer{padding: 16px; color: var(--muted); font-size: 12px; text-align:center; opacity:.9;}
    dialog{
      border:none; border-radius: 20px;
      width:min(840px, 94vw);
      background: linear-gradient(180deg, rgba(18,27,47,.98), rgba(15,23,42,.98));
      color:var(--text);
      box-shadow: var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.55)}
    .dlg-hd{padding:14px 14px 10px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center}
    .dlg-bd{padding:14px}
    .follow{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:10px;
      display:flex; flex-direction:column; gap:8px;
    }
    .follow-entry{
      border:1px dashed rgba(255,255,255,.14);
      border-radius:14px;
      padding:10px;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .table th,.table td{
      padding:10px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    .table th{color: var(--muted); font-weight:700; background: rgba(255,255,255,.02)}
    .table tr:last-child td{border-bottom:none}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px;
    }
    .pill .bar{
      width:10px; height:10px; border-radius:999px; background: var(--info);
    }
    .pill.ok .bar{background: var(--ok)}
    .pill.warn .bar{background: var(--warn)}
    .pill.bad .bar{background: var(--bad)}
    /* Print */
    @media print{
      body{background:#fff; color:#111}
      header, .no-print{display:none !important}
      .print-card{
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 14px;
      }
      .table{border-color:#ddd}
      .table th,.table td{border-color:#ddd; color:#111}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap title">
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1>ALPACEL ‚Äî Agenda Sanitaria (Anomal√≠as & Seguimiento)</h1>
        <div class="sub">Registrar, evidenciar, dar seguimiento y cerrar. Lo tradicional: orden. Lo moderno: sem√°foro y datos.</div>
      </div>
    </div>

    <div class="toolbar no-print">
      <button class="btn primary" id="btnNew">‚ûï Nueva anomal√≠a</button>
      <button class="btn" id="btnExport">‚¨áÔ∏è Exportar JSON</button>
      <label class="btn" for="importFile" style="margin:0; cursor:pointer;">‚¨ÜÔ∏è Importar JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none;">
      <button class="btn" id="btnExportCSV">üìÑ Exportar CSV</button>
      <button class="btn danger" id="btnWipe">üßπ Borrar todo</button>
      <a class="btn ghost" href="#" id="btnHelp">‚ùì Ayuda</a>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- FORM -->
    <section class="card" id="formCard">
      <div class="hd">
        <h2>Registro r√°pido</h2>
        <span class="chip"><span class="dot info"></span><span class="small">Guarda autom√°tico</span></span>
      </div>
      <div class="bd">
        <form id="anomForm" class="no-print">
          <label>Farmacia / Sucursal</label>
          <select id="farmacia" required></select>

          <div class="row">
            <div>
              <label>√Årea</label>
              <select id="area" required></select>
            </div>
            <div>
              <label>Tipo</label>
              <select id="tipo" required>
                <option>Sanitario</option>
                <option>Operativo</option>
                <option>Capacitaci√≥n</option>
                <option>Auditor√≠a</option>
              </select>
            </div>
          </div>

          <label>Descripci√≥n de la anomal√≠a (clara y verificable)</label>
          <textarea id="descripcion" placeholder="Ej: Se encontr√≥ producto con caducidad vencida en anaquel A-3..." required></textarea>

          <div class="row3">
            <div>
              <label>Prioridad</label>
              <select id="prioridad" required>
                <option>Alta</option>
                <option selected>Media</option>
                <option>Baja</option>
              </select>
            </div>
            <div>
              <label>Estatus</label>
              <select id="estatus" required>
                <option>Abierta</option>
                <option>En proceso</option>
                <option>En espera</option>
                <option>Cerrada</option>
              </select>
            </div>
            <div>
              <label>Responsable</label>
              <input id="responsable" placeholder="Ej: Encargada / Auxiliar / Nombre" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Fecha de detecci√≥n</label>
              <input id="fechaDeteccion" type="date" required />
            </div>
            <div>
              <label>Compromiso (fecha l√≠mite)</label>
              <input id="fechaLimite" type="date" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Evidencia (link o nota)</label>
              <input id="evidencia" placeholder="Ej: Foto en Drive / 'Carpeta f√≠sica' / Folio" />
            </div>
            <div>
              <label>Checklist sugerido</label>
              <select id="checkTemplate">
                <option value="">(Opcional) Cargar checklist‚Ä¶</option>
              </select>
            </div>
          </div>

          <label>Acci√≥n correctiva sugerida (qu√© se debe hacer)</label>
          <textarea id="accion" placeholder="Ej: Retirar lote, registrar en bit√°cora, capacitaci√≥n r√°pida y firma..." required></textarea>

          <div class="hr"></div>

          <div class="row">
            <button type="submit" class="btn ok">‚úÖ Guardar anomal√≠a</button>
            <button type="button" class="btn" id="btnClear">üßº Limpiar</button>
          </div>

          <p class="hint">
            Tip de coordinadora: escribe como si ma√±ana te lo pidiera COFEPRIS. Si no se puede comprobar, no existe. üòå
          </p>
        </form>

        <div class="hr"></div>

        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <h2 style="margin:0; font-size:15px;">Sem√°foro por farmacia</h2>
            <span class="hint">Conteo sobre lo filtrado (si filtras, cambia el sem√°foro).</span>
          </div>
          <div class="hr"></div>
          <div id="farmTableWrap"></div>
        </div>
      </div>
    </section>

    <!-- LIST -->
    <section class="card">
      <div class="hd">
        <h2>Agenda y seguimiento</h2>
        <div class="chips">
          <span class="chip"><span class="dot ok"></span><span class="small">Cerradas</span></span>
          <span class="chip"><span class="dot warn"></span><span class="small">En proceso / espera</span></span>
          <span class="chip"><span class="dot bad"></span><span class="small">Abiertas</span></span>
        </div>
      </div>

      <div class="bd">
        <div class="kpis" id="kpis"></div>

        <div class="hr"></div>

        <div class="row4 no-print">
          <div>
            <label>Buscar</label>
            <input id="q" placeholder="Farmacia, √°rea, responsable, texto‚Ä¶" />
          </div>
          <div>
            <label>Filtrar estatus</label>
            <select id="fEstatus">
              <option value="">Todos</option>
              <option>Abierta</option>
              <option>En proceso</option>
              <option>En espera</option>
              <option>Cerrada</option>
            </select>
          </div>
          <div>
            <label>Filtrar prioridad</label>
            <select id="fPrioridad">
              <option value="">Todas</option>
              <option>Alta</option>
              <option>Media</option>
              <option>Baja</option>
            </select>
          </div>
          <div>
            <label>Ordenar</label>
            <select id="sortBy">
              <option value="updated_desc" selected>√öltima actualizaci√≥n (desc)</option>
              <option value="due_asc">Compromiso (asc)</option>
              <option value="prio_desc">Prioridad (Alta‚ÜíBaja)</option>
              <option value="status">Estatus</option>
              <option value="farmacia">Farmacia (A‚ÜíZ)</option>
            </select>
          </div>
        </div>

        <div class="row3 no-print">
          <div>
            <label>Rango: detecci√≥n desde</label>
            <input id="fromDate" type="date" />
          </div>
          <div>
            <label>hasta</label>
            <input id="toDate" type="date" />
          </div>
          <div>
            <label>Vista</label>
            <select id="viewMode">
              <option value="cards" selected>Tarjetas</option>
              <option value="table">Tabla</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="list" id="list"></div>
      </div>
    </section>
  </div>

  <div class="footer">ALPACEL ‚Ä¢ Tradici√≥n: orden y evidencia ‚Ä¢ Futuro: seguimiento sin excusas ‚ú®</div>
</main>

<!-- DIALOG: FOLLOW-UP / DETAIL -->
<dialog id="dlg">
  <div class="dlg-hd">
    <div>
      <div class="mono" style="font-weight:800" id="dlgTitle">Detalle</div>
      <div class="hint" id="dlgSub"></div>
    </div>
    <div class="no-print" style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="btnPrintActa">üñ®Ô∏è Imprimir acta</button>
      <button class="btn" id="dlgClose">‚úñÔ∏è Cerrar</button>
    </div>
  </div>
  <div class="dlg-bd">
    <div class="row3 no-print">
      <div>
        <label>Estatus</label>
        <select id="dlgEstatus">
          <option>Abierta</option>
          <option>En proceso</option>
          <option>En espera</option>
          <option>Cerrada</option>
        </select>
      </div>
      <div>
        <label>Prioridad</label>
        <select id="dlgPrioridad">
          <option>Alta</option>
          <option>Media</option>
          <option>Baja</option>
        </select>
      </div>
      <div>
        <label>Compromiso (fecha l√≠mite)</label>
        <input id="dlgFechaLimite" type="date" />
      </div>
    </div>

    <div class="row no-print">
      <div>
        <label>Responsable</label>
        <input id="dlgResponsable" />
      </div>
      <div>
        <label>Evidencia</label>
        <input id="dlgEvidencia" />
      </div>
    </div>

    <div class="row no-print">
      <div>
        <label>Farmacia</label>
        <select id="dlgFarmacia"></select>
      </div>
      <div>
        <label>√Årea</label>
        <select id="dlgArea"></select>
      </div>
    </div>

    <label class="no-print">Descripci√≥n</label>
    <textarea class="no-print" id="dlgDescripcion"></textarea>

    <label class="no-print">Acci√≥n correctiva</label>
    <textarea class="no-print" id="dlgAccion"></textarea>

    <div class="hr"></div>

    <div class="follow no-print">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div>
          <div style="font-weight:800">Seguimiento</div>
          <div class="hint">Avances con fecha. El historial es tu escudo.</div>
        </div>
        <button class="btn primary" id="btnAddFollow">üìù Agregar seguimiento</button>
      </div>

      <div id="followList"></div>
    </div>

    <div class="hr no-print"></div>

    <div class="no-print" style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <button class="btn ok" id="btnSaveDlg">üíæ Guardar cambios</button>
      <button class="btn danger" id="btnDelete">üóëÔ∏è Eliminar anomal√≠a</button>
    </div>

    <!-- Printable Acta -->
    <div id="actaPrint" class="print-card" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:14px;">
        <div>
          <div style="font-weight:900; font-size:16px;">ALPACEL ‚Äî Acta de Anomal√≠a y Seguimiento</div>
          <div style="margin-top:6px; font-size:12px;">Coordinaci√≥n sanitaria ‚Ä¢ Evidencia ‚Ä¢ Acci√≥n correctiva ‚Ä¢ Cierre</div>
        </div>
        <div style="text-align:right; font-size:12px;">
          <div><b>Fecha de impresi√≥n:</b> <span id="actaToday"></span></div>
          <div><b>Folio:</b> <span class="mono" id="actaFolio"></span></div>
        </div>
      </div>

      <div style="height:10px;"></div>

      <table class="table">
        <tr>
          <th>Farmacia</th><td id="actaFarm"></td>
          <th>√Årea</th><td id="actaArea"></td>
        </tr>
        <tr>
          <th>Tipo</th><td id="actaTipo"></td>
          <th>Prioridad</th><td id="actaPrio"></td>
        </tr>
        <tr>
          <th>Estatus</th><td id="actaStatus"></td>
          <th>Responsable</th><td id="actaResp"></td>
        </tr>
        <tr>
          <th>Detecci√≥n</th><td id="actaDet"></td>
          <th>Compromiso</th><td id="actaDue"></td>
        </tr>
        <tr>
          <th>Evidencia</th><td colspan="3" id="actaEvi"></td>
        </tr>
        <tr>
          <th>Descripci√≥n</th><td colspan="3" id="actaDesc"></td>
        </tr>
        <tr>
          <th>Acci√≥n correctiva</th><td colspan="3" id="actaAcc"></td>
        </tr>
      </table>

      <div style="height:12px;"></div>

      <div style="font-weight:800; margin-bottom:6px;">Seguimiento</div>
      <table class="table" id="actaFollowTbl">
        <tr><th>#</th><th>Fecha</th><th>Tipo</th><th>Nota</th></tr>
      </table>

      <div style="height:14px;"></div>
      <div class="row" style="gap:18px;">
        <div>
          <div style="font-size:12px;"><b>Firma responsable</b></div>
          <div style="height:34px; border-bottom:1px solid #bbb;"></div>
          <div style="font-size:12px; color:#444;">Nombre y firma</div>
        </div>
        <div>
          <div style="font-size:12px;"><b>Firma coordinaci√≥n sanitaria</b></div>
          <div style="height:34px; border-bottom:1px solid #bbb;"></div>
          <div style="font-size:12px; color:#444;">Nombre y firma</div>
        </div>
      </div>
    </div>
  </div>
</dialog>

<!-- DIALOG: ADD FOLLOW-UP -->
<dialog id="dlgFollow" class="no-print">
  <div class="dlg-hd">
    <div style="font-weight:800">Nuevo seguimiento</div>
    <button class="btn" id="dlgFollowClose">‚úñÔ∏è Cerrar</button>
  </div>
  <div class="dlg-bd">
    <div class="row">
      <div>
        <label>Fecha</label>
        <input id="fDate" type="date" />
      </div>
      <div>
        <label>Tipo</label>
        <select id="fType">
          <option>Avance</option>
          <option>Capacitaci√≥n</option>
          <option>Evidencia</option>
          <option>Visita</option>
          <option>Observaci√≥n</option>
          <option>Cierre</option>
        </select>
      </div>
    </div>
    <label>Nota</label>
    <textarea id="fNote" placeholder="Ej: Se retir√≥ producto, se registr√≥ destrucci√≥n, evidencia en carpeta..."></textarea>
    <div class="hr"></div>
    <button class="btn ok" id="btnSaveFollow">‚úÖ Guardar seguimiento</button>
  </div>
</dialog>

<!-- DIALOG: HELP -->
<dialog id="dlgHelp" class="no-print">
  <div class="dlg-hd">
    <div style="font-weight:800">Ayuda r√°pida</div>
    <button class="btn" id="dlgHelpClose">‚úñÔ∏è Cerrar</button>
  </div>
  <div class="dlg-bd">
    <div class="hint" style="font-size:13px;">
      <p><b>1) Esto trabaja offline</b>: guarda en el navegador (localStorage). Exporta JSON para respaldo.</p>
      <p><b>2) Sem√°foro</b>: una farmacia est√° <b>roja</b> si tiene abiertas o vencidas; <b>amarilla</b> si est√° en proceso/espera; <b>verde</b> si todo est√° cerrado.</p>
      <p><b>3) Checklist</b>: puedes cargar un checklist sugerido por tipo/√°rea para que el registro quede parejo.</p>
      <p><b>4) Acta</b>: abre un registro y usa <b>Imprimir acta</b>. Para PDF: impresora ‚Üí ‚ÄúGuardar como PDF‚Äù.</p>
      <p><b>GitHub</b>: sube el archivo <span class="mono">index.html</span> a tu repo (o esta carpeta completa) y activa GitHub Pages.</p>
      <p style="margin:0;"><i>La tradici√≥n dice: ‚Äúpapelito habla‚Äù. La realidad 2026 dice: ‚Äúexporta JSON y respalda‚Äù.</i></p>
    </div>
  </div>
</dialog>

<script>
  // =========================
  // Config (SUCURSALES / √ÅREAS / CHECKLISTS)
  // =========================
  const CONFIG = {
    sucursales: [
      "Chihuahua 95",
      "Ju√°rez 30",
      "Ju√°rez 10",
      "Ju√°rez 49",
      "Ju√°rez 63",
      "Ju√°rez 97",
      "Ju√°rez 101",
      "Ju√°rez 102",
      "Ju√°rez 119",
      "Rivera Lara",
      "Valle del Sol",
      "Otra (escribe en evidencia)"
    ],
    areas: [
      "Almac√©n / Anaqueles",
      "Caducidades",
      "Temperaturas / Bit√°cora",
      "Receta / Controlados",
      "Higiene / Limpieza",
      "Atenci√≥n y trato",
      "Caja / Cobro",
      "Documentaci√≥n / PNO",
      "Consultorio",
      "Otro"
    ],
    checklists: [
      {
        id: "caducidades_basico",
        name: "Caducidades ‚Äî Barrido b√°sico (anaquel + almac√©n)",
        appliesTo: ["Caducidades","Almac√©n / Anaqueles"],
        text: [
          "Retirar producto caducado/vencido y separar en √°rea definida.",
          "Revisar frente y fondo del anaquel (FIFO/FEFO).",
          "Registrar hallazgo (lote/caducidad/cantidad) en bit√°cora interna.",
          "Colocar se√±alizaci√≥n temporal si aplica.",
          "Tomar evidencia (foto) y resguardar en carpeta f√≠sica/digital.",
          "Notificar a encargada y definir fecha compromiso."
        ].join("\\n")
      },
      {
        id: "temperaturas_bitacora",
        name: "Temperaturas ‚Äî Bit√°cora y term√≥metro",
        appliesTo: ["Temperaturas / Bit√°cora"],
        text: [
          "Verificar term√≥metro funcional y ubicado correctamente.",
          "Revisar bit√°cora completa (sin huecos) y firmas.",
          "Si hay desviaci√≥n: registrar acci√≥n correctiva inmediata.",
          "Validar rango y constancia (d√≠a/turno).",
          "Guardar evidencia (foto de lectura + bit√°cora).",
          "Capacitaci√≥n breve si hay reincidencia."
        ].join("\\n")
      },
      {
        id: "higiene_limpieza",
        name: "Higiene ‚Äî Limpieza general (√°reas cr√≠ticas)",
        appliesTo: ["Higiene / Limpieza","Consultorio"],
        text: [
          "Revisi√≥n visual: pisos, vitrinas, anaqueles, botes de basura.",
          "Ba√±o: limpieza, insumos, bit√°cora (si aplica).",
          "Consultorio: camilla, superficies, RPBI conforme a procedimiento.",
          "Uniforme: completo y limpio; cabello y u√±as conforme a pol√≠tica.",
          "Evidencia fotogr√°fica antes/despu√©s cuando aplique.",
          "Asignar responsable y fecha de cierre."
        ].join("\\n")
      },
      {
        id: "documentacion_pno",
        name: "Documentaci√≥n ‚Äî PNO / bit√°coras / evidencias",
        appliesTo: ["Documentaci√≥n / PNO"],
        text: [
          "Verificar PNO vigente disponible y accesible.",
          "Bit√°coras completas: temperatura, limpieza, inventario/caducidades (seg√∫n aplique).",
          "Firmas y fechas: sin tachones; si hay correcci√≥n, justificada.",
          "Carpeta de evidencias por mes (f√≠sica o digital).",
          "Reportes diarios/semana seg√∫n pol√≠tica.",
          "Si falta algo: levantar plan de acci√≥n (qui√©n/cu√°ndo) y seguimiento."
        ].join("\\n")
      },
      {
        id: "atencion_trato",
        name: "Atenci√≥n ‚Äî Trato, orden y protocolo",
        appliesTo: ["Atenci√≥n y trato","Caja / Cobro"],
        text: [
          "Saludo y cierre conforme al est√°ndar.",
          "No discutir frente a cliente. Cero gritos. Cero palabras altisonantes.",
          "Orden en mostrador y caja; tickets/arqueos conforme a proceso.",
          "Ofertas/impulso conforme a estrategia sin presionar mal.",
          "Registrar incidente si hubo queja y plan de mejora.",
          "Dar seguimiento y confirmar cambio de conducta."
        ].join("\\n")
      }
    ]
  };

  // =========================
  // Storage
  // =========================
  const KEY = "alpacel_agenda_anomalias_v2";
  const nowISO = () => new Date().toISOString();
  const uid = () => Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

  function loadData(){
    try{
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){
      console.warn("Datos da√±ados:", e);
      return [];
    }
  }
  function saveData(items){ localStorage.setItem(KEY, JSON.stringify(items)); }

  // =========================
  // State
  // =========================
  let items = loadData();
  let activeId = null;

  // =========================
  // Helpers
  // =========================
  function prioRank(p){ return p==="Alta" ? 3 : (p==="Media" ? 2 : 1); }
  function statusRank(s){
    const map = {"Abierta":1,"En proceso":2,"En espera":3,"Cerrada":4};
    return map[s] || 99;
  }
  function badgeClassStatus(s){ if(s==="Cerrada") return "ok"; if(s==="Abierta") return "bad"; return "warn"; }
  function badgeClassPrio(p){ if(p==="Alta") return "bad"; if(p==="Media") return "warn"; return "info"; }
  function safeText(t){ return (t ?? "").toString(); }
  function formatDate(d){
    if(!d) return "‚Äî";
    try{ const [y,m,day] = d.split("-"); return `${day}/${m}/${y}`; }catch{ return d; }
  }
  function todayYMD(){ return new Date().toISOString().slice(0,10); }
  function isOverdue(item){
    if(!item.fechaLimite) return false;
    if(item.estatus==="Cerrada") return false;
    return new Date(item.fechaLimite) < new Date(todayYMD());
  }
  function escapeHTML(str){
    return safeText(str)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function snippet(text, n){
    const t = safeText(text).replace(/\\s+/g," ").trim();
    return t.length > n ? t.slice(0,n-1)+"‚Ä¶" : t;
  }
  function semaforoForCounts(openCnt, midCnt, overdueCnt){
    // Rojo si hay vencidas o abiertas, Amarillo si solo en proceso/espera, Verde si todo cerrado
    if(overdueCnt>0 || openCnt>0) return "bad";
    if(midCnt>0) return "warn";
    return "ok";
  }

  // =========================
  // DOM
  // =========================
  const $ = (id)=>document.getElementById(id);

  // Form
  const form = $("anomForm");
  const farmacia = $("farmacia");
  const area = $("area");
  const descripcion = $("descripcion");
  const prioridad = $("prioridad");
  const estatus = $("estatus");
  const tipo = $("tipo");
  const responsable = $("responsable");
  const fechaLimite = $("fechaLimite");
  const fechaDeteccion = $("fechaDeteccion");
  const evidencia = $("evidencia");
  const accion = $("accion");
  const checkTemplate = $("checkTemplate");

  // Filters
  const q = $("q");
  const fEstatus = $("fEstatus");
  const fPrioridad = $("fPrioridad");
  const sortBy = $("sortBy");
  const fromDate = $("fromDate");
  const toDate = $("toDate");
  const viewMode = $("viewMode");

  // List & KPIs
  const list = $("list");
  const kpis = $("kpis");
  const farmTableWrap = $("farmTableWrap");

  // Dialogs
  const dlg = $("dlg");
  const dlgFollow = $("dlgFollow");
  const dlgHelp = $("dlgHelp");

  // Buttons
  $("btnNew").addEventListener("click", ()=>{ clearForm(); });
  $("btnClear").addEventListener("click", clearForm);
  $("btnExport").addEventListener("click", exportJSON);
  $("btnExportCSV").addEventListener("click", exportCSV);
  $("importFile").addEventListener("change", importJSON);
  $("btnWipe").addEventListener("click", wipeAll);

  $("btnHelp").addEventListener("click", (e)=>{ e.preventDefault(); dlgHelp.showModal(); });
  $("dlgHelpClose").addEventListener("click", ()=> dlgHelp.close());

  // Dialog detail buttons
  $("dlgClose").addEventListener("click", ()=>{ dlg.close(); });
  $("btnPrintActa").addEventListener("click", ()=> printActa());

  // Dialog fields
  const dlgTitle = $("dlgTitle");
  const dlgSub = $("dlgSub");
  const dlgEstatus = $("dlgEstatus");
  const dlgPrioridad = $("dlgPrioridad");
  const dlgFechaLimite = $("dlgFechaLimite");
  const dlgResponsable = $("dlgResponsable");
  const dlgEvidencia = $("dlgEvidencia");
  const dlgDescripcion = $("dlgDescripcion");
  const dlgAccion = $("dlgAccion");
  const dlgFarmacia = $("dlgFarmacia");
  const dlgArea = $("dlgArea");
  const followList = $("followList");

  $("btnSaveDlg").addEventListener("click", saveDialogChanges);
  $("btnDelete").addEventListener("click", deleteActive);

  $("btnAddFollow").addEventListener("click", ()=>{
    $("fDate").value = todayYMD();
    $("fType").value = "Avance";
    $("fNote").value = "";
    dlgFollow.showModal();
  });
  $("dlgFollowClose").addEventListener("click", ()=> dlgFollow.close());
  $("btnSaveFollow").addEventListener("click", saveFollowUp);

  // Filters events
  [q,fEstatus,fPrioridad,sortBy,fromDate,toDate,viewMode].forEach(el=> el.addEventListener("input", render));

  // =========================
  // Init selects
  // =========================
  function fillSelect(sel, arr, placeholder){
    sel.innerHTML = "";
    if(placeholder){
      const op = document.createElement("option");
      op.value = "";
      op.textContent = placeholder;
      sel.appendChild(op);
    }
    for(const v of arr){
      const o = document.createElement("option");
      o.value = v; o.textContent = v;
      sel.appendChild(o);
    }
  }
  fillSelect(farmacia, CONFIG.sucursales, "Selecciona sucursal‚Ä¶");
  fillSelect(area, CONFIG.areas, "Selecciona √°rea‚Ä¶");
  fillSelect(dlgFarmacia, CONFIG.sucursales, "");
  fillSelect(dlgArea, CONFIG.areas, "");

  // checklist selector
  checkTemplate.innerHTML = `<option value="">(Opcional) Cargar checklist‚Ä¶</option>` + CONFIG.checklists.map(c=>{
    return `<option value="${c.id}">${c.name}</option>`;
  }).join("");

  // Set default detection date = today
  fechaDeteccion.value = todayYMD();

  // =========================
  // Form actions
  // =========================
  checkTemplate.addEventListener("change", ()=>{
    const id = checkTemplate.value;
    if(!id) return;
    const c = CONFIG.checklists.find(x=>x.id===id);
    if(!c) return;
    // Put checklist into "accion" if empty-ish or append
    const prefix = "CHECKLIST SUGERIDO:\\n";
    const block = prefix + c.text;
    if(!accion.value.trim()){
      accion.value = block;
    }else{
      accion.value = accion.value.trim() + "\\n\\n" + block;
    }
  });

  form.addEventListener("submit", (e)=>{
    e.preventDefault();

    const item = {
      id: uid(),
      farmacia: safeText(farmacia.value).trim(),
      area: safeText(area.value).trim(),
      descripcion: safeText(descripcion.value).trim(),
      prioridad: safeText(prioridad.value).trim(),
      estatus: safeText(estatus.value).trim(),
      tipo: safeText(tipo.value).trim(),
      responsable: safeText(responsable.value).trim(),
      fechaDeteccion: safeText(fechaDeteccion.value).trim(),
      fechaLimite: safeText(fechaLimite.value).trim(),
      evidencia: safeText(evidencia.value).trim(),
      accion: safeText(accion.value).trim(),
      follow: [],
      createdAt: nowISO(),
      updatedAt: nowISO()
    };

    items.unshift(item);
    saveData(items);
    clearForm();
    render();
  });

  function clearForm(){
    farmacia.value = "";
    area.value = "";
    descripcion.value = "";
    prioridad.value = "Media";
    estatus.value = "Abierta";
    tipo.value = "Sanitario";
    responsable.value = "";
    fechaLimite.value = "";
    fechaDeteccion.value = todayYMD();
    evidencia.value = "";
    accion.value = "";
    checkTemplate.value = "";
  }

  // =========================
  // Detail dialog
  // =========================
  function openItem(id){
    const item = items.find(x=>x.id===id);
    if(!item) return;
    activeId = id;

    dlgTitle.textContent = `${item.farmacia || "Sin farmacia"} ‚Äî ${item.area || "Sin √°rea"}`;
    dlgSub.textContent = `Detectada: ${formatDate(item.fechaDeteccion)} ‚Ä¢ √öltima actualizaci√≥n: ${new Date(item.updatedAt).toLocaleString()}`;

    dlgEstatus.value = item.estatus;
    dlgPrioridad.value = item.prioridad;
    dlgFechaLimite.value = item.fechaLimite || "";
    dlgResponsable.value = item.responsable || "";
    dlgEvidencia.value = item.evidencia || "";
    dlgDescripcion.value = item.descripcion || "";
    dlgAccion.value = item.accion || "";
    dlgFarmacia.value = item.farmacia || "";
    dlgArea.value = item.area || "";

    renderFollow(item);
    showEditView();
    dlg.showModal();
  }
  window.openItem = openItem;

  function renderFollow(item){
    const f = item.follow || [];
    if(f.length === 0){
      followList.innerHTML = `<div class="hint">Sin seguimientos a√∫n. En el mundo real eso se traduce como ‚Äúpeligro de olvido‚Äù.</div>`;
      return;
    }
    followList.innerHTML = f
      .slice()
      .sort((a,b)=> (a.date||"").localeCompare(b.date||""))
      .map((x, idx)=>`
        <div class="follow-entry">
          <div class="meta">
            <span class="badge info">${formatDate(x.date)}</span>
            <span class="badge">${escapeHTML(x.type)}</span>
            <span class="badge">${idx+1}/${f.length}</span>
          </div>
          <div style="margin-top:8px; white-space:pre-wrap">${escapeHTML(x.note)}</div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
            <button class="btn danger" onclick="removeFollow('${item.id}', '${x.id}')">üóëÔ∏è Quitar</button>
          </div>
        </div>
      `).join("");
  }

  function saveDialogChanges(){
    const item = items.find(x=>x.id===activeId);
    if(!item) return;

    item.estatus = dlgEstatus.value;
    item.prioridad = dlgPrioridad.value;
    item.fechaLimite = dlgFechaLimite.value || "";
    item.responsable = dlgResponsable.value || "";
    item.evidencia = dlgEvidencia.value || "";
    item.descripcion = dlgDescripcion.value || "";
    item.accion = dlgAccion.value || "";
    item.farmacia = dlgFarmacia.value || item.farmacia;
    item.area = dlgArea.value || item.area;
    item.updatedAt = nowISO();

    saveData(items);
    render();
    dlg.close();
  }

  function deleteActive(){
    if(!activeId) return;
    const item = items.find(x=>x.id===activeId);
    const name = item ? (item.farmacia || "esta anomal√≠a") : "esta anomal√≠a";
    if(!confirm(`¬øEliminar ${name}? Esto no se puede deshacer.`)) return;

    items = items.filter(x=>x.id!==activeId);
    saveData(items);
    activeId = null;
    render();
    dlg.close();
  }

  function saveFollowUp(){
    const item = items.find(x=>x.id===activeId);
    if(!item) return;

    const date = $("fDate").value;
    const type = $("fType").value;
    const note = $("fNote").value.trim();

    if(!date || !note){
      alert("Pon fecha y nota. Un seguimiento sin nota es como un acta sin firma.");
      return;
    }

    item.follow = item.follow || [];
    item.follow.push({ id: uid(), date, type, note });
    item.updatedAt = nowISO();

    if(type==="Cierre" && item.estatus!=="Cerrada"){
      item.estatus = "Cerrada";
    }

    saveData(items);
    renderFollow(item);
    dlgFollow.close();
    render();
  }

  window.removeFollow = function(itemId, followId){
    const item = items.find(x=>x.id===itemId);
    if(!item) return;
    item.follow = (item.follow||[]).filter(f=>f.id!==followId);
    item.updatedAt = nowISO();
    saveData(items);
    renderFollow(item);
    render();
  }

  // =========================
  // Filtering / Sorting
  // =========================
  function applyFilters(){
    const query = q.value.trim().toLowerCase();
    const se = fEstatus.value;
    const sp = fPrioridad.value;
    const fd = fromDate.value;
    const td = toDate.value;

    return items.filter(x=>{
      const hay = [
        x.farmacia, x.area, x.descripcion, x.prioridad, x.estatus, x.tipo, x.responsable, x.evidencia, x.accion
      ].join(" ").toLowerCase();

      if(query && !hay.includes(query)) return false;
      if(se && x.estatus !== se) return false;
      if(sp && x.prioridad !== sp) return false;

      if(fd && x.fechaDeteccion && x.fechaDeteccion < fd) return false;
      if(td && x.fechaDeteccion && x.fechaDeteccion > td) return false;

      return true;
    });
  }

  function applySort(arr){
    const s = sortBy.value;
    const a = arr.slice();

    if(s==="updated_desc"){
      a.sort((x,y)=> (y.updatedAt||"").localeCompare(x.updatedAt||""));
    } else if(s==="due_asc"){
      a.sort((x,y)=> (x.fechaLimite||"9999-12-31").localeCompare(y.fechaLimite||"9999-12-31"));
    } else if(s==="prio_desc"){
      a.sort((x,y)=> prioRank(y.prioridad) - prioRank(x.prioridad));
    } else if(s==="status"){
      a.sort((x,y)=> statusRank(x.estatus) - statusRank(y.estatus));
    } else if(s==="farmacia"){
      a.sort((x,y)=> (x.farmacia||"").localeCompare(y.farmacia||""));
    }
    return a;
  }

  // =========================
  // KPIs + Sem√°foro por farmacia
  // =========================
  function renderKPIs(filtered){
    const total = filtered.length;
    const abiertas = filtered.filter(x=>x.estatus==="Abierta").length;
    const proceso = filtered.filter(x=>x.estatus==="En proceso" || x.estatus==="En espera").length;
    const cerradas = filtered.filter(x=>x.estatus==="Cerrada").length;
    const vencidas = filtered.filter(isOverdue).length;

    kpis.innerHTML = `
      <div class="kpi"><div class="t">Total</div><div class="n">${total}</div></div>
      <div class="kpi"><div class="t">Abiertas</div><div class="n">${abiertas}</div></div>
      <div class="kpi"><div class="t">En proceso / espera</div><div class="n">${proceso}</div></div>
      <div class="kpi"><div class="t">Cerradas ‚Ä¢ Vencidas</div><div class="n">${cerradas} ‚Ä¢ ${vencidas}</div></div>
    `;
  }

  function renderFarmTable(filtered){
    // group by farmacia
    const by = new Map();
    for(const s of CONFIG.sucursales){
      by.set(s, {farmacia:s, total:0, abiertas:0, proceso:0, cerradas:0, vencidas:0});
    }
    for(const it of filtered){
      const k = it.farmacia || "‚Äî";
      if(!by.has(k)) by.set(k, {farmacia:k, total:0, abiertas:0, proceso:0, cerradas:0, vencidas:0});
      const g = by.get(k);
      g.total++;
      if(it.estatus==="Abierta") g.abiertas++;
      else if(it.estatus==="Cerrada") g.cerradas++;
      else g.proceso++;
      if(isOverdue(it)) g.vencidas++;
    }
    const rows = Array.from(by.values())
      .filter(r=> r.total>0 || CONFIG.sucursales.includes(r.farmacia))
      .sort((a,b)=>{
        // prioritize: red first, then yellow, then green; then total desc
        const sa = semaforoForCounts(a.abiertas, a.proceso, a.vencidas);
        const sb = semaforoForCounts(b.abiertas, b.proceso, b.vencidas);
        const rank = {bad:1, warn:2, ok:3};
        if(rank[sa]!==rank[sb]) return rank[sa]-rank[sb];
        return b.total - a.total;
      });

    const table = `
      <table class="table">
        <tr>
          <th>Sem√°foro</th>
          <th>Farmacia</th>
          <th>Total</th>
          <th>Abiertas</th>
          <th>En proceso/espera</th>
          <th>Cerradas</th>
          <th>Vencidas</th>
          <th>Acci√≥n</th>
        </tr>
        ${rows.map(r=>{
          const s = semaforoForCounts(r.abiertas, r.proceso, r.vencidas);
          const label = s==="bad" ? "Rojo" : (s==="warn" ? "Amarillo" : "Verde");
          return `
            <tr>
              <td><span class="pill ${s}"><span class="bar"></span>${label}</span></td>
              <td>${escapeHTML(r.farmacia)}</td>
              <td>${r.total}</td>
              <td>${r.abiertas}</td>
              <td>${r.proceso}</td>
              <td>${r.cerradas}</td>
              <td>${r.vencidas}</td>
              <td><button class="btn primary" onclick="filterByFarmacia('${escapeHTML(r.farmacia).replaceAll("'","&#039;")}')">Ver</button></td>
            </tr>
          `;
        }).join("")}
      </table>
      <div class="hint" style="margin-top:10px;">
        Sem√°foro: <b>Rojo</b> si hay abiertas o vencidas; <b>Amarillo</b> si solo hay en proceso/espera; <b>Verde</b> si todo est√° cerrado.
      </div>
    `;
    farmTableWrap.innerHTML = table;
  }

  window.filterByFarmacia = function(f){
    // quick filter by setting query to farmacia
    q.value = f;
    render();
    // scroll list into view
    document.getElementById("list").scrollIntoView({behavior:"smooth", block:"start"});
  }

  // =========================
  // Render list: cards or table
  // =========================
  function renderListCards(filtered){
    list.className = "list";
    list.innerHTML = filtered.map(item=>{
      const overdue = isOverdue(item);
      const statusCls = badgeClassStatus(item.estatus);
      const prioCls = badgeClassPrio(item.prioridad);
      const dueTxt = item.fechaLimite ? formatDate(item.fechaLimite) : "‚Äî";
      const followCount = (item.follow||[]).length;

      return `
        <div class="item" role="button" tabindex="0" onclick="openItem('${item.id}')">
          <div>
            <h3>${escapeHTML(item.farmacia || "Sin farmacia")} ‚Äî <span class="muted">${escapeHTML(item.area || "Sin √°rea")}</span></h3>
            <div class="meta">
              <span class="badge ${statusCls}">${escapeHTML(item.estatus)}</span>
              <span class="badge ${prioCls}">Prioridad: ${escapeHTML(item.prioridad)}</span>
              <span class="badge">Tipo: ${escapeHTML(item.tipo)}</span>
              <span class="badge">Detectada: ${formatDate(item.fechaDeteccion)}</span>
              <span class="badge ${overdue ? "bad" : ""}">Compromiso: ${dueTxt}${overdue ? " ‚ö†Ô∏è" : ""}</span>
              <span class="badge">Seguimientos: ${followCount}</span>
              ${item.responsable ? `<span class="badge">Resp: ${escapeHTML(item.responsable)}</span>` : ""}
            </div>
            <div class="hint" style="margin-top:10px; white-space:pre-wrap">${escapeHTML(snippet(item.descripcion, 160))}</div>
          </div>

          <div class="actions">
            <span class="badge">Abrir</span>
            <span class="hint" style="text-align:right">${new Date(item.updatedAt).toLocaleString()}</span>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderListTable(filtered){
    list.className = "";
    const rows = filtered.map(item=>{
      const overdue = isOverdue(item);
      const statusCls = badgeClassStatus(item.estatus);
      const prioCls = badgeClassPrio(item.prioridad);
      return `
        <tr onclick="openItem('${item.id}')" style="cursor:pointer;">
          <td><span class="badge ${statusCls}">${escapeHTML(item.estatus)}</span></td>
          <td><span class="badge ${prioCls}">${escapeHTML(item.prioridad)}</span></td>
          <td>${escapeHTML(item.farmacia||"")}</td>
          <td>${escapeHTML(item.area||"")}</td>
          <td>${formatDate(item.fechaDeteccion)}</td>
          <td><span class="badge ${overdue ? "bad" : ""}">${item.fechaLimite ? formatDate(item.fechaLimite) : "‚Äî"}${overdue ? " ‚ö†Ô∏è" : ""}</span></td>
          <td>${escapeHTML(item.responsable||"‚Äî")}</td>
          <td>${escapeHTML(snippet(item.descripcion, 80))}</td>
        </tr>
      `;
    }).join("");

    list.innerHTML = `
      <table class="table">
        <tr>
          <th>Estatus</th>
          <th>Prioridad</th>
          <th>Farmacia</th>
          <th>√Årea</th>
          <th>Detecci√≥n</th>
          <th>Compromiso</th>
          <th>Responsable</th>
          <th>Descripci√≥n</th>
        </tr>
        ${rows}
      </table>
      <div class="hint" style="margin-top:10px;">Tip: da clic en cualquier fila para abrir el detalle y agregar seguimiento.</div>
    `;
  }

  // =========================
  // Main render
  // =========================
  function render(){
    const filtered = applySort(applyFilters());
    renderKPIs(filtered);
    renderFarmTable(filtered);

    if(filtered.length === 0){
      list.innerHTML = `<div class="hint">No hay registros con esos filtros. O todo est√° perfecto (lol), o est√°s filtrando demasiado.</div>`;
      return;
    }

    if(viewMode.value === "table") renderListTable(filtered);
    else renderListCards(filtered);
  }

  // =========================
  // Export / Import
  // =========================
  function exportJSON(){
    const data = { app:"ALPACEL Agenda Sanitaria", version:2, exportedAt: nowISO(), items };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ALPACEL_agenda_${todayYMD()}.json`;
    document.body.appendChild(a);
    a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function exportCSV(){
    const cols = ["id","farmacia","area","tipo","prioridad","estatus","responsable","fechaDeteccion","fechaLimite","evidencia","descripcion","accion","seguimientos","updatedAt"];
    const lines = [cols.join(",")];
    for(const it of items){
      const followCount = (it.follow||[]).length;
      const row = [
        it.id,
        it.farmacia, it.area, it.tipo,
        it.prioridad, it.estatus, it.responsable,
        it.fechaDeteccion, it.fechaLimite,
        it.evidencia,
        (it.descripcion||"").replaceAll("\\n"," "),
        (it.accion||"").replaceAll("\\n"," "),
        followCount,
        it.updatedAt
      ].map(v=>{
        const s = (v ?? "").toString().replaceAll('"','""');
        return `"${s}"`;
      });
      lines.push(row.join(","));
    }
    const blob = new Blob([lines.join("\\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ALPACEL_agenda_${todayYMD()}.csv`;
    document.body.appendChild(a);
    a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function importJSON(ev){
    const file = ev.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        const incoming = Array.isArray(data) ? data : (data.items || []);
        if(!Array.isArray(incoming)) throw new Error("Formato inv√°lido");

        const map = new Map(items.map(x=>[x.id,x]));
        for(const it of incoming){
          if(!it.id) it.id = uid();
          // normalize follow
          it.follow = it.follow || [];
          it.updatedAt = it.updatedAt || nowISO();
          it.createdAt = it.createdAt || nowISO();
          map.set(it.id, it);
        }
        items = Array.from(map.values());
        saveData(items);
        render();
        alert("Importaci√≥n lista ‚úÖ");
      }catch(e){
        alert("No se pudo importar: " + e.message);
      }finally{
        ev.target.value = "";
      }
    };
    reader.readAsText(file, "utf-8");
  }

  function wipeAll(){
    if(!confirm("¬øBorrar TODO? Esto elimina todos los registros del navegador.")) return;
    items = [];
    saveData(items);
    render();
  }

  // =========================
  // Acta print
  // =========================
  function showPrintView(){
    // Hide edit blocks, show acta
    document.getElementById("actaPrint").style.display = "block";
  }
  function showEditView(){
    document.getElementById("actaPrint").style.display = "none";
  }

  function printActa(){
    const item = items.find(x=>x.id===activeId);
    if(!item) return;

    // Fill acta
    document.getElementById("actaToday").textContent = new Date().toLocaleString();
    document.getElementById("actaFolio").textContent = item.id;

    document.getElementById("actaFarm").textContent = item.farmacia || "‚Äî";
    document.getElementById("actaArea").textContent = item.area || "‚Äî";
    document.getElementById("actaTipo").textContent = item.tipo || "‚Äî";
    document.getElementById("actaPrio").textContent = item.prioridad || "‚Äî";
    document.getElementById("actaStatus").textContent = item.estatus || "‚Äî";
    document.getElementById("actaResp").textContent = item.responsable || "‚Äî";
    document.getElementById("actaDet").textContent = formatDate(item.fechaDeteccion);
    document.getElementById("actaDue").textContent = item.fechaLimite ? formatDate(item.fechaLimite) : "‚Äî";
    document.getElementById("actaEvi").textContent = item.evidencia || "‚Äî";
    document.getElementById("actaDesc").textContent = item.descripcion || "‚Äî";
    document.getElementById("actaAcc").textContent = item.accion || "‚Äî";

    const tbl = document.getElementById("actaFollowTbl");
    // reset rows (keep header)
    tbl.innerHTML = `<tr><th>#</th><th>Fecha</th><th>Tipo</th><th>Nota</th></tr>`;
    const f = (item.follow||[]).slice().sort((a,b)=> (a.date||"").localeCompare(b.date||""));
    if(f.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4">Sin seguimiento registrado</td>`;
      tbl.appendChild(tr);
    }else{
      f.forEach((x,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td>${formatDate(x.date)}</td><td>${escapeHTML(x.type)}</td><td>${escapeHTML(x.note)}</td>`;
        tbl.appendChild(tr);
      });
    }

    showPrintView();
    setTimeout(()=>{
      window.print();
      setTimeout(()=>{ showEditView(); }, 300);
    }, 100);
  }

  // =========================
  // Follow list view
  // =========================
  function renderFollow(item){
    const f = item.follow || [];
    if(f.length === 0){
      followList.innerHTML = `<div class="hint">Sin seguimientos a√∫n. Si esto es importante, agrega al menos un avance hoy.</div>`;
      return;
    }
    followList.innerHTML = f
      .slice()
      .sort((a,b)=> (a.date||"").localeCompare(b.date||""))
      .map((x, idx)=>`
        <div class="follow-entry">
          <div class="meta">
            <span class="badge info">${formatDate(x.date)}</span>
            <span class="badge">${escapeHTML(x.type)}</span>
            <span class="badge">${idx+1}/${f.length}</span>
          </div>
          <div style="margin-top:8px; white-space:pre-wrap">${escapeHTML(x.note)}</div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
            <button class="btn danger" onclick="removeFollow('${item.id}', '${x.id}')">üóëÔ∏è Quitar</button>
          </div>
        </div>
      `).join("");
  }

  // First render
  render();
</script>
</body>
</html>
